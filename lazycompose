#!/bin/bash

function compose-list() {
    projects=$(compose-find)
    header=$(echo "$projects" | head -n 1)
    echo "$projects" | sed "1d" | fzf \
        --reverse \
        --exact \
        --color="header:blue:bold,pointer:bright-blue:bold,list-border:$FZF_LIST_BORDER_COLOR" \
        --header "$header" \
        --preview-window down:70%:wrap:follow \
        --preview "compose-stats {1}" \
        --bind "enter:execute(compose-ps-bind {1} {2})+reload(compose-find | sed '1d')"
}

function compose-find() {
    composeList=$(docker-compose ls --all --format json | jq -r '.[] | "\(.Name)|\(.ConfigFiles)|\(.Status)"')
    composeFiles=$(
        echo -e "PROJECT\tPATH\tSTATUS"
        find "$COMPOSE_PATH" -maxdepth "$COMPOSE_FIND_DEPTH" -type f -name "*compose.y*ml" | while read -r path; do
            composeElemetn=$(echo "$composeList" | grep -F "$path" | head -n 1)
            if [ -n "$composeElemetn" ]; then
                projectName=$(echo "$composeElemetn" | awk -F'|' '{print $1}')
                status=$(echo "$composeElemetn" | awk -F'|' '{print $3}')
                if [[ "$status" == *","* ]]; then
                    status="ðŸŸ¡ $status"
                else
                    status="ðŸŸ¢ $status"
                fi
            else
                projectName=$(basename "$(dirname "$path")")
                serviceCount=$(cat "$path" | yq e '.services | length')
                status="ðŸ”´ down($serviceCount)"
            fi
            echo -e "$projectName\t$path\t$status"
        done
    )
    echo "$composeFiles" | column -t -s $'\t'
}

function compose-stats() {
    command -v bc >/dev/null 2>&1 || { echo "bc not found"; return 1; }
    export COMPOSE_PROJECT_NAME="$1"
    declare -A cpuSum
    declare -A cpuCount
    while true; do
        stats=$(docker-compose stats --all --no-stream \
            --format "{{.Name}}\t{{.CPUPerc}}\t{{.MemPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}\t{{.PIDs}}" | sed 's/\x1b\[[0-9;]*m//g')
        output="NAME\tCPU\tAVG\tMEM\tMEM USAGE / LIMIT\tNET I/O\tBLOCK I/O\tPIDS\n"
        while IFS=$'\t' read -r name cpu memPercent memUsage net block pids; do
            [[ -z "$name" ]] && continue
            cpu=$(echo "$cpu" | sed 's/%//g; s/--/0/g; s/ //g')
            if [[ "$cpu" =~ ^[0-9]+([.][0-9]+)?$ ]]; then
                cpuSum["$name"]=$(echo "${cpuSum["$name"]:-0} + $cpu" | bc)
                cpuCount["$name"]=$((${cpuCount["$name"]:-0} + 1))
                avg=$(echo "scale=2; ${cpuSum["$name"]} / ${cpuCount["$name"]}" | bc)
                [[ "$avg" =~ ^\. ]] && avg="0$avg"
                [[ ! "$avg" =~ \. ]] && avg="${avg}.00"
                cpuAvg="${avg}%"
            else
                cpuAvg="0.00%"
            fi
            cpu="${cpu}%"
            output+="$(printf "%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s" "$name" "$cpu" "$cpuAvg" "$memPercent" "$memUsage" "$net" "$block" "$pids")\n"
        done <<< "$stats"
        echo -en "\033[H\033[2J"
        output=$(echo -e "$output" | column -t -s $'\t')
        header=$(echo -e "$output" | head -n 1)
        header="\x1b[34;1m$header\x1b[0m"
        echo -e "$header"
        echo -e "$output" | sed '1d'
    done
}

function compose-ps-bind() {
    export COMPOSE_PROJECT_NAME="$1"
    export COMPOSE_FILE="$2"
    ps=$(compose-services)
    echo "$ps" | sed "1d" | fzf \
        --reverse \
        --exact \
        --color="header:blue:bold,pointer:bright-blue:bold,list-border:$FZF_LIST_BORDER_COLOR" \
        --header "$(echo "$ps" | head -n 1)" \
        --preview-window down:70%:wrap:follow \
        --preview "compose-logs {1}" \
        --bind "enter:execute(custom-commands-list {1} {2} {3})+reload(compose-services | sed '1d')+transform-header(compose-services | head -n 1)"
}

function compose-services() {
    ps=$(docker-compose ps --all --format "table {{.Name}}\t{{.Service}}\t{{.Image}}\t{{.State}}\t{{.Status}}\t{{.RunningFor}}\t{{.Command}}\t{{.Ports}}")
    serviceCount=$(echo "$ps" | wc -l)
    if [ "$serviceCount" -le 1 ]; then
        ps=$(
            {
                echo -e "NAME\tSERVICE\tIMAGE\tSTATE"
                services=$(yq e '.services | select(. != null) | keys | .[]' "$COMPOSE_FILE")
                if [[ -z "$services" ]]; then
                    echo -e "null\tnull\tnull\tdown"
                else
                    echo "$services" | while read -r svc; do
                        cn=$(yq e ".services.$svc.container_name // \"null\"" "$COMPOSE_FILE")
                        img=$(yq e ".services.$svc.image // \"null\"" "$COMPOSE_FILE")
                        echo -e "$cn\t$svc\t$img\tdown"
                    done
                fi
            } | column -t -s $'\t'
        )
    fi
    lines=()
    header=true
    while read -r line; do
        if $header; then 
            header=false
            line=$(echo "$line" | sed "s/STATUS/   STATUS/")
            lines+=("$line")
            continue
        fi
        state=$(echo "$line" | awk '{print $4}')
        case "$state" in
            run*)  status="ðŸŸ¢" ;;
            exit*) status="ðŸ”´" ;;
            down*) status="ðŸ”´" ;;
            *)     status="ðŸŸ¡" ;;
        esac
        resetColor="\033[0m"
        line=$(echo "$line" | sed "s/$state/$status $state/")
        lines+=("$line")
    done < <(echo "$ps")
    IFS=$'\n'
    echo "${lines[*]}" | column -t -s $'\t'
}

function compose-logs() {
    export COMPOSE_SERVICE_NAME="$1"
    while true; do
        echo -en "\033[H\033[2J"
        docker logs "$COMPOSE_SERVICE_NAME" --tail 100 2>&1 | tspin
        sleep 1
    done
}

function custom-commands-list() {
    export COMPOSE_CONTAINER_NAME="$1"
    export COMPOSE_SERVICE_NAME="$2"
    export COMPOSE_IMAGE_NAME="$3"
    mapfile -t commands < <(yq e '.customCommands[].name' config.yml)
    commandsName=$(printf "%s\n" "${commands[@]}")
    echo "$commandsName" | fzf \
        --reverse \
        --exact \
        --preview-window up:30%:wrap:follow \
        --color "list-border:$FZF_LIST_BORDER_COLOR" \
        --preview "compose-ps-preview" \
        --bind "enter:execute(custom-command-run '{}')"
}

function compose-ps-preview() {
    while true; do
        ps=$(compose-services)
        header=$(echo "$ps" | head -n 1)
        header="ðŸ“Š Status\n\n   \x1b[34;1m$header\x1b[0m"
        lines=()
        while read -r line; do
            serviceName=$(echo "$line" | awk '{print $1}')
            if [[ "$serviceName" == "$COMPOSE_SERVICE_NAME" ]]; then
                line="\x1b[34;1mâ–¶\x1b[0m  $line"
            else
                line="   $line"
            fi
            lines+=("$line")
        done < <(echo "$ps" | sed "1d")
        echo -en "\033[H\033[2J"
        echo -e "$header"
        IFS=$'\n'
        echo -e "${lines[*]}"
    done
}

function custom-command-run() {
    COMMAND_NAME="$*"
    COMMAND=$(yq e ".customCommands[] | select(.name == \"$COMMAND_NAME\") | .command" config.yml)
    attach=$(yq e ".customCommands[] | select(.name == \"$COMMAND_NAME\") | .attach" config.yml)
    if [ "$attach" == "true" ]; then
        custom-command-attach "$COMMAND"
    else
        echo -en "\033[H\033[2J"
        eval "$COMMAND"
    fi
}

function custom-command-attach() {
    COMMAND="$*"
    eval "$COMMAND" 2>&1 | fzf \
    --reverse \
    --bind "result:last" \
    --preview-window up:30%:wrap:follow \
    --preview "compose-ps-preview" \
    --pointer="" \
    --disabled \
    --no-input \
    --bind "start:unbind(up,down,pgup,pgdn)" \
    --color "fg+:-1,bg+:-1,hl+:-1"
}

export -f compose-list
export -f compose-find
export -f compose-stats

export -f compose-ps-bind
export -f compose-services
export -f compose-logs

export -f custom-commands-list
export -f compose-ps-preview
export -f custom-command-run
export -f custom-command-attach

export COMPOSE_PATH=${COMPOSE_PATH:-/docker}
export COMPOSE_FIND_DEPTH=${COMPOSE_FIND_DEPTH:-3}

export FZF_LIST_BORDER_COLOR="#87af87"
export FZF_DEFAULT_OPTS="--no-sort --ansi --wrap --border --list-border --height=100% --prompt='ðŸ”Ž ' --pointer='â–¶ '"

echo -en "\033[H\033[2J"
if [ "$TTYD_MODE" == "true" ]; then
    TTYD_OPTIONS="-W -p ${TTYD_PORT:-3333}"
    if [ -n "${TTYD_USER}" ] && [ -n "${TTYD_PASS}" ]; then
        TTYD_OPTIONS+=" -c ${TTYD_USER}:${TTYD_PASS}"
    fi
    ttyd $TTYD_OPTIONS bash -c compose-list
else
    compose-list
fi